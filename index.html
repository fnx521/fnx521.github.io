<!DOCTYPE html>
<html>

<head>
	<title>Sulfuras Points Cheatsheet</title>
	<meta charset="utf-8" />
</head>

<body>
	<p>Sulfuras Points Cheatsheet, v0.0.4</p>

	<button id="getdata_button" onclick="handleGetDataClick()">Get Data</button>
	<!-- <pre id="content" style="white-space: pre-wrap;"></pre> -->
	<div id="message"></div>

	<script type="text/javascript">
		const API_KEY = 'AIzaSyCNAFRhLa3kMQVTBJsf4-b7yrwlA3PLFDw';
		const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

		let gapiInited = false;

		/**
		 * Callback after api.js is loaded.
		 */
		function gapiLoaded() {
			console.log('GApi loaded');
			gapi.load('client', initializeGapiClient);
		}

		/**
		 * Callback after the API client is loaded. Loads the
		 * discovery doc to initialize the API.
		 */
		async function initializeGapiClient() {
			await gapi.client.init({
				apiKey: API_KEY,
				discoveryDocs: [DISCOVERY_DOC],
			});
			gapiInited = true;
			console.log('Client initialized');
			fetchAndProcessData();
		}

		/**
		 * Print the names and majors of students in a sample spreadsheet:
		 * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
		 */
		/*async function listMajors() {
		  let response;
		  try {
			// Fetch first 10 files
			response = await gapi.client.sheets.spreadsheets.values.get({
			  spreadsheetId: '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms',
			  range: 'Class Data!A2:E',
			});
		  } catch (err) {
			document.getElementById('content').innerText = err.message;
			return;
		  }
		  const range = response.result;
		  if (!range || !range.values || range.values.length == 0) {
			document.getElementById('content').innerText = 'No values found.';
			return;
		  }
		  // Flatten to string to display
		  const output = range.values.reduce(
			  (str, row) => `${str}${row[0]}, ${row[4]}\n`,
			  'Name, Major:\n');
		  document.getElementById('content').innerText = output;
		}*/

		function showMessage(message) {
			document.getElementById('message').innerText = message;
		}

		async function fetchAndProcessData() {
			let response;
			try {
				response = await gapi.client.sheets.spreadsheets.values.get({
					spreadsheetId: '1s_Ja3ae3QePMox_8gMdkIfjLAVcxsLMVSAUdpbdP2to',
					range: 'Log!A4114:H',
				});

				const range = response.result;
				if (!range || !range.values || range.values.length == 0) {
					showMessage('Data fetched: no data found');
					console.log('Data fetched: no data found');
				} else {
					console.log(`Data fetched: ${range.values.length} rows`);
					processRange(range);
				}
			} catch (err) {
				showMessage(`Error fetching data: ${err.message}`);
				console.log(`Error fetching data: ${err.message}`);
			}
		}

		function getIndexOrThrow(arr, val, message) {
			const idx = arr.indexOf(val);
			if (idx < 0) {
				throw message;
			}
		}

		class HeaderMeta {
			constructor(headerRow) {
				this.headerRow = headerRow;
				this.num = getIndexOrThrow(headerRow, '#', `Cannot get index of column: '#'`);
				this.date = getIndexOrThrow(headerRow, 'Date', `Cannot get index of column: 'Date'`);
				this.name = getIndexOrThrow(headerRow, 'Name', `Cannot get index of column: 'Name'`);
				this.class = getIndexOrThrow(headerRow, 'Class', `Cannot get index of column: 'Class'`);
				this.itemId = getIndexOrThrow(headerRow, 'Item', `Cannot get index of column: 'Item'`);
				this.points = getIndexOrThrow(headerRow, 'New Points', `Cannot get index of column: 'New Points'`);
			}
		}

		class SoftRes {
			constructor(num, date, name, clazz, itemId, points) {
				this.num = num;
				this.date = date;
				this.name = name;
				this.class = clazz;
				this.itemId = itemId;
				this.points = points;
			}
		}

		function processRange(range) {
			console.log(`Range requested: ${range.range}`);
			const rows = range.values;

			// get last header (from bottom)
			let headerRowIdx = -1;
			for (let i = rows.length - 1; i >= 0; i--) {
				const row = rows[i];
				if (row.length > 0 && row[0] == '#') {
					headerRowIdx = i;
					break;
				}
			}

			if (headerRowIdx === -1) {
				console.log('Error: Header row not found');
				return;
			}

			const headerRow = rows[headerRowIdx];
			console.log(`headerRowIdx: ${headerRowIdx}, header: ${headerRow}`);
			const header = new HeaderMeta(headerRow);

			// read data
			const srData = [];
			for (let i = headerRowIdx + 1; i < rows.length; i++) {
				const row = rows[i];
				if (row.length == 0) {
					break;
				}
				srData.push(new SoftRes(
					Number(row[header.num]),
					row[header.date],
					row[header.name],
					row[header.class],
					row[header.itemId],
					row[header.points]
				));
			}
			console.log(`SrData items: ${srData.length}`);

			if (srData.length == 0) {
				showMessage('Parse error: no softres rows found');
				return;
			}

			showMessage(`Raid date: ${srData[0].date}, log records found: ${srData.length}`);
		}
	</script>
	<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>

</html>
